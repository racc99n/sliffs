<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Linking - Prima789</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 30px;
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(238, 90, 36, 0.3);
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.2);
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin: 0 10px;
            position: relative;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .step.completed {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            width: 40px;
            height: 2px;
            background: rgba(102, 126, 234, 0.2);
            z-index: -1;
        }

        .step:last-child::after {
            display: none;
        }

        .step.completed::after {
            background: #4ecdc4;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sync-method-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sync-method {
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .sync-method.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .sync-method-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .sync-method-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .sync-method-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            border: 2px solid #ddd;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 30px 20px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .error {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #d63031;
        }

        .warning {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #e17055;
        }

        .info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .hidden { display: none; }

        .account-info {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .account-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .account-row:last-child {
            border-bottom: none;
        }

        .account-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .account-value {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>กำลังโหลด...</p>
        </div>

        <!-- Header -->
        <div id="header" class="header hidden">
            <div class="logo">P</div>
            <h1>เชื่อมต่อบัญชี</h1>
            <p class="subtitle">เชื่อมต่อบัญชี Prima789 กับ LINE ของคุณ</p>
        </div>

        <!-- Step Indicator -->
        <div id="stepIndicator" class="step-indicator hidden">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <!-- Messages -->
        <div id="successMessage" class="message success hidden">
            <div style="font-size: 24px; margin-bottom: 10px;">✅</div>
            <div><strong>เชื่อมต่อสำเร็จ!</strong></div>
            <div>บัญชี Prima789 ของคุณถูกเชื่อมต่อกับ LINE แล้ว</div>
        </div>

        <div id="errorMessage" class="message error hidden">
            <div style="font-size: 24px; margin-bottom: 10px;">❌</div>
            <div id="errorText">เกิดข้อผิดพลาด</div>
        </div>

        <div id="warningMessage" class="message warning hidden">
            <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
            <div id="warningText">คำเตือน</div>
        </div>

        <div id="infoMessage" class="message info hidden">
            <div style="font-size: 24px; margin-bottom: 10px;">ℹ️</div>
            <div id="infoText">ข้อมูล</div>
        </div>

        <!-- Step 1: Choose Sync Method -->
        <div id="step1Content" class="hidden">
            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: #333;">เลือกวิธีการเชื่อมต่อ</h3>
                
                <div class="sync-method-selector">
                    <div class="sync-method" data-method="manual">
                        <div class="sync-method-icon">👤</div>
                        <div class="sync-method-title">Manual Sync</div>
                        <div class="sync-method-desc">กรอกข้อมูลด้วยตนเอง</div>
                    </div>
                    <div class="sync-method selected" data-method="auto">
                        <div class="sync-method-icon">🔄</div>
                        <div class="sync-method-title">Auto Sync</div>
                        <div class="sync-method-desc">ตรวจจับอัตโนมัติ</div>
                    </div>
                </div>

                <button class="btn btn-primary" id="nextStep1">
                    ถัดไป <span>→</span>
                </button>
            </div>
        </div>

        <!-- Step 2: Manual Input / Auto Detection -->
        <div id="step2Content" class="hidden">
            <!-- Manual Input Form -->
            <div id="manualForm" class="hidden">
                <div class="form-section">
                    <h3 style="margin-bottom: 20px; color: #333;">กรอกข้อมูลบัญชี Prima789</h3>
                    
                    <div class="form-group">
                        <label for="username">ชื่อผู้ใช้ (Username)</label>
                        <input type="text" id="username" placeholder="กรอกชื่อผู้ใช้">
                    </div>

                    <div class="form-group">
                        <label for="password">รหัสผ่าน (Password)</label>
                        <input type="password" id="password" placeholder="กรอกรหัสผ่าน">
                    </div>

                    <button class="btn btn-primary" id="verifyManual">
                        <span id="verifyIcon">🔍</span> ตรวจสอบบัญชี
                    </button>
                </div>
            </div>

            <!-- Auto Detection -->
            <div id="autoDetection">
                <div class="form-section">
                    <h3 style="margin-bottom: 20px; color: #333;">ตรวจจับบัญชีอัตโนมัติ</h3>
                    
                    <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                        เปิดเว็บไซต์ Prima789 แล้วเข้าสู่ระบบ ระบบจะตรวจจับบัญชีของคุณโดยอัตโนมัติ
                    </p>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <div id="detectionStatus" class="info">
                        <div>🔍 กำลังค้นหาบัญชี Prima789...</div>
                    </div>

                    <button class="btn btn-primary" id="startAutoDetection">
                        🚀 เริ่มตรวจจับ
                    </button>

                    <button class="btn btn-secondary" id="switchToManual">
                        👤 เปลี่ยนเป็นการกรอกด้วยตนเอง
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Account Confirmation -->
        <div id="step3Content" class="hidden">
            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: #333;">ยืนยันข้อมูลบัญชี</h3>
                
                <div class="account-info" id="accountInfo">
                    <div class="account-row">
                        <span class="account-label">ชื่อผู้ใช้:</span>
                        <span class="account-value" id="confirmUsername">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">ชื่อ-นามสกุล:</span>
                        <span class="account-value" id="confirmFullName">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">เบอร์โทร:</span>
                        <span class="account-value" id="confirmPhone">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">อีเมล:</span>
                        <span class="account-value" id="confirmEmail">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">ธนาคาร:</span>
                        <span class="account-value" id="confirmBank">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">สมาชิกตั้งแต่:</span>
                        <span class="account-value" id="confirmMemberSince">-</span>
                    </div>
                </div>

                <button class="btn btn-primary" id="confirmLinking">
                    ✅ ยืนยันการเชื่อมต่อ
                </button>

                <button class="btn btn-secondary" id="backToStep2">
                    ← กลับไปแก้ไข
                </button>
            </div>
        </div>

        <!-- Success Actions -->
        <div id="successActions" class="hidden">
            <button class="btn btn-primary" id="openMemberCard">
                📱 ไปที่ Member Card
            </button>
            <button class="btn btn-secondary" id="closeLiff">
                ✅ เสร็จสิ้น
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let userProfile = null;
        let currentStep = 1;
        let selectedSyncMethod = 'auto';
        let detectionInterval = null;
        let foundAccount = null;
        let isMockMode = true; // Set to false when API is ready

        // Mock account data for testing
        const mockAccounts = [
            {
                username: "player123",
                fullName: "สมชาย ใจดี", 
                phoneNumber: "081-234-5678",
                email: "somchai@email.com",
                bank: "ธนาคารกรุงเทพ",
                accountNumber: "123-4-56789-0",
                memberSince: "2023-01-15",
                balance: 15420.75,
                tier: "Gold",
                points: 12850
            },
            {
                username: "winner789",
                fullName: "สมหญิง รวย",
                phoneNumber: "089-876-5432", 
                email: "somying@email.com",
                bank: "ธนาคารไทยพาณิชย์",
                accountNumber: "987-6-54321-0",
                memberSince: "2023-03-20",
                balance: 8750.25,
                tier: "Silver", 
                points: 5420
            }
        ];

        // Utility functions
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function formatDateTime(dateString) {
            return new Intl.DateTimeFormat('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }).format(new Date(dateString));
        }

        // UI functions
        function showLoading(show = true) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showSuccess(message) {
            hideAllMessages();
            if (message) {
                document.querySelector('#successMessage div:last-child').textContent = message;
            }
            document.getElementById('successMessage').classList.remove('hidden');
        }

        function showError(message) {
            hideAllMessages();
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function showWarning(message) {
            hideAllMessages();
            document.getElementById('warningText').textContent = message;
            document.getElementById('warningMessage').classList.remove('hidden');
        }

        function showInfo(message) {
            hideAllMessages();
            document.getElementById('infoText').textContent = message;
            document.getElementById('infoMessage').classList.remove('hidden');
        }

        function hideAllMessages() {
            document.querySelectorAll('.message').forEach(msg => {
                msg.classList.add('hidden');
            });
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
        }

        function showStep(step) {
            // Hide all step contents
            document.querySelectorAll('[id*="step"][id*="Content"]').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show current step
            document.getElementById(`step${step}Content`).classList.remove('hidden');
            
            // Update step indicator
            updateStepIndicator(step);
            currentStep = step;
        }

        // API functions - แก้ไขใช้ apiCall แทน makeApiCall
        async function apiCall(endpoint, options = {}) {
            const baseUrl = window.location.origin;
            const url = endpoint.startsWith('http') ? endpoint : `${baseUrl}/.netlify/functions${endpoint}`;
            
            console.log(`API Call: ${url}`, options.method || 'GET');
            
            try {
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    body: options.body
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`API Response: ${url}`, data);
                
                return { json: async () => data };
                
            } catch (error) {
                console.error(`API Error: ${url}`, error);
                
                // Fallback to mock for demo purposes
                if (window.location.hostname === 'localhost' || window.location.hostname.includes('.netlify.app')) {
                    console.warn('API call failed, using mock response for demo');
                    return mockApiCall(endpoint, options);
                }
                
                throw error;
            }
        }

        // Mock API function (fallback for demo)
        async function mockApiCall(endpoint, options = {}) {
            console.log(`Mock API Call: ${endpoint}`, options);
            
            await delay(500 + Math.random() * 1000);
            
            let mockResponse;
            
            switch (endpoint) {
                case '/check-account-linking':
                    mockResponse = {
                        success: true,
                        isLinked: Math.random() > 0.8,
                        data: mockAccounts[0]
                    };
                    break;
                case '/link-prima789-account':
                    const data = JSON.parse(options.body || '{}');
                    if (data.syncMethod === 'manual') {
                        const account = mockAccounts.find(acc => 
                            acc.username.toLowerCase().includes((data.username || '').toLowerCase())
                        );
                        mockResponse = {
                            success: !!account,
                            accountFound: !!account,
                            account: account,
                            message: account ? 
                                'ตรวจสอบบัญชีสำเร็จ' : 
                                'ไม่พบบัญชีที่ตรงกับข้อมูลที่กรอก'
                        };
                    } else {
                        // Auto detection
                        const account = mockAccounts[Math.floor(Math.random() * mockAccounts.length)];
                        mockResponse = {
                            success: Math.random() > 0.3,
                            accountFound: true,
                            account: account,
                            message: 'ตรวจจับบัญชีสำเร็จ'
                        };
                    }
                    break;
                case '/confirm-account-linking':
                    mockResponse = {
                        success: Math.random() > 0.1,
                        message: 'เชื่อมต่อบัญชีสำเร็จแล้ว'
                    };
                    break;
                default:
                    mockResponse = { success: false, message: 'Unknown endpoint' };
            }
            
            return { json: async () => mockResponse };
        }

        // Account linking functions
        async function checkExistingLink() {
            try {
                const response = await apiCall('/check-account-linking', {
                    method: 'POST',
                    body: JSON.stringify({
                        lineUserId: userProfile.userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.isLinked) {
                    showSuccess('บัญชีของคุณถูกเชื่อมต่อแล้ว');
                    document.getElementById('successActions').classList.remove('hidden');
                    return true;
                }
                
                return false;
                
            } catch (error) {
                console.error('Error checking existing link:', error);
                return false;
            }
        }

        async function verifyManualAccount() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showWarning('กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
                return;
            }
            
            try {
                hideAllMessages();
                
                const verifyBtn = document.getElementById('verifyManual');
                const verifyIcon = document.getElementById('verifyIcon');
                
                verifyBtn.disabled = true;
                verifyIcon.textContent = '⏳';
                
                await delay(2000); // Simulate API call
                
                const response = await apiCall('/link-prima789-account', {
                    method: 'POST',
                    body: JSON.stringify({
                        lineUserId: userProfile.userId,
                        syncMethod: 'manual',
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.accountFound) {
                    foundAccount = result.account;
                    displayAccountConfirmation();
                    showStep(3);
                } else {
                    showError(result.message || 'ไม่พบบัญชีที่ตรงกับข้อมูลที่กรอก');
                }
                
            } catch (error) {
                console.error('Error verifying account:', error);
                showError('เกิดข้อผิดพลาดในการตรวจสอบบัญชี');
            } finally {
                const verifyBtn = document.getElementById('verifyManual');
                const verifyIcon = document.getElementById('verifyIcon');
                
                verifyBtn.disabled = false;
                verifyIcon.textContent = '🔍';
            }
        }

        async function startAutoDetection() {
            try {
                hideAllMessages();
                
                const startBtn = document.getElementById('startAutoDetection');
                const progressFill = document.getElementById('progressFill');
                const detectionStatus = document.getElementById('detectionStatus');
                
                startBtn.disabled = true;
                startBtn.textContent = '⏳ กำลังค้นหา...';
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 300);
                
                await delay(3000); // Simulate detection time
                
                const response = await apiCall('/prima789-line-sync', {
                    method: 'POST',
                    body: JSON.stringify({
                        lineUserId: userProfile.userId,
                        syncMethod: 'auto'
                    })
                });
                
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                if (result.success && result.accountFound) {
                    foundAccount = result.account;
                    detectionStatus.innerHTML = `
                        <div>✅ พบบัญชี: ${result.account.username}</div>
                    `;
                    
                    await delay(1000);
                    displayAccountConfirmation();
                    showStep(3);
                } else {
                    detectionStatus.innerHTML = `
                        <div>❌ ไม่พบบัญชี Prima789</div>
                    `;
                    showWarning('ไม่สามารถตรวจจับบัญชีได้ กรุณาลองใหม่หรือใช้การกรอกด้วยตนเอง');
                }
                
            } catch (error) {
                console.error('Error in auto detection:', error);
                showError('เกิดข้อผิดพลาดในการตรวจจับบัญชี');
            } finally {
                const startBtn = document.getElementById('startAutoDetection');
                startBtn.disabled = false;
                startBtn.innerHTML = '🚀 เริ่มตรวจจับ';
            }
        }

        function displayAccountConfirmation() {
            if (!foundAccount) return;
            
            document.getElementById('confirmUsername').textContent = foundAccount.username || '-';
            document.getElementById('confirmFullName').textContent = foundAccount.fullName || '-';
            document.getElementById('confirmPhone').textContent = foundAccount.phoneNumber || '-';
            document.getElementById('confirmEmail').textContent = foundAccount.email || '-';
            document.getElementById('confirmBank').textContent = foundAccount.bank || '-';
            document.getElementById('confirmMemberSince').textContent = 
                foundAccount.memberSince ? formatDateTime(foundAccount.memberSince) : '-';
        }

        async function confirmAccountLinking() {
            try {
                hideAllMessages();
                
                const confirmBtn = document.getElementById('confirmLinking');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '⏳ กำลังเชื่อมต่อ...';
                
                await delay(2000); // Simulate API call
                
                const response = await apiCall('/confirm-account-linking', {
                    method: 'POST',
                    body: JSON.stringify({
                        lineUserId: userProfile.userId,
                        accountData: foundAccount
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('step3Content').classList.add('hidden');
                    document.getElementById('stepIndicator').classList.add('hidden');
                    showSuccess('เชื่อมต่อบัญชีสำเร็จแล้ว!');
                    document.getElementById('successActions').classList.remove('hidden');
                } else {
                    showError(result.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
                }
                
            } catch (error) {
                console.error('Error confirming account linking:', error);
                showError('เกิดข้อผิดพลาดในการยืนยันการเชื่อมต่อ');
            } finally {
                const confirmBtn = document.getElementById('confirmLinking');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '✅ ยืนยันการเชื่อมต่อ';
            }
        }

        // Event handlers
        function setupEventHandlers() {
            // Sync method selection
            document.querySelectorAll('.sync-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.sync-method').forEach(m => m.classList.remove('selected'));
                    method.classList.add('selected');
                    selectedSyncMethod = method.dataset.method;
                });
            });

            // Step 1: Next button
            document.getElementById('nextStep1').addEventListener('click', () => {
                hideAllMessages();
                
                if (selectedSyncMethod === 'manual') {
                    document.getElementById('manualForm').classList.remove('hidden');
                    document.getElementById('autoDetection').classList.add('hidden');
                } else {
                    document.getElementById('manualForm').classList.add('hidden');
                    document.getElementById('autoDetection').classList.remove('hidden');
                }
                
                showStep(2);
            });

            // Step 2: Manual verification
            document.getElementById('verifyManual').addEventListener('click', verifyManualAccount);

            // Step 2: Auto detection
            document.getElementById('startAutoDetection').addEventListener('click', startAutoDetection);

            // Step 2: Switch to manual
            document.getElementById('switchToManual').addEventListener('click', () => {
                selectedSyncMethod = 'manual';
                document.getElementById('manualForm').classList.remove('hidden');
                document.getElementById('autoDetection').classList.add('hidden');
            });

            // Step 3: Confirm linking
            document.getElementById('confirmLinking').addEventListener('click', confirmAccountLinking);

            // Step 3: Back to step 2
            document.getElementById('backToStep2').addEventListener('click', () => {
                hideAllMessages();
                showStep(2);
            });

            // Success actions
            document.getElementById('openMemberCard').addEventListener('click', () => {
                if (window.liff && window.liff.isInClient()) {
                    window.liff.openWindow({
                        url: 'https://liff.line.me/YOUR_MEMBER_CARD_LIFF_ID',
                        external: false
                    });
                } else {
                    window.open('/liff-member-card.html', '_blank');
                }
            });

            document.getElementById('closeLiff').addEventListener('click', () => {
                if (window.liff && window.liff.isInClient()) {
                    window.liff.closeWindow();
                } else {
                    window.close();
                }
            });

            // Form validation
            document.getElementById('username').addEventListener('input', () => {
                hideAllMessages();
            });

            document.getElementById('password').addEventListener('input', () => {
                hideAllMessages();
            });
        }

        // LIFF initialization
        async function initializeLiff() {
            try {
                showLoading(true);
                
                if (window.liff) {
                    await window.liff.init({
                        liffId: '2008090006-ZMGmoOla' // Replace with actual LIFF ID
                    });

                    if (!window.liff.isLoggedIn()) {
                        window.liff.login();
                        return;
                    }

                    // Get user profile
                    userProfile = await window.liff.getProfile();
                    console.log('User profile:', userProfile);
                } else {
                    // Mock profile for testing
                    userProfile = {
                        userId: 'U' + Math.random().toString(36).substring(2, 15),
                        displayName: 'Test User',
                        pictureUrl: null,
                        statusMessage: null
                    };
                }

                // Check if account is already linked
                const isLinked = await checkExistingLink();
                
                if (!isLinked) {
                    // Show linking interface
                    document.getElementById('header').classList.remove('hidden');
                    document.getElementById('stepIndicator').classList.remove('hidden');
                    showStep(1);
                }

            } catch (error) {
                console.error('LIFF initialization error:', error);
                showError('ไม่สามารถเชื่อมต่อกับ LINE ได้');
                
                // Try with mock data
                userProfile = {
                    userId: 'mock_user_' + Date.now(),
                    displayName: 'Mock User'
                };
                
                document.getElementById('header').classList.remove('hidden');
                document.getElementById('stepIndicator').classList.remove('hidden');
                showStep(1);
            } finally {
                showLoading(false);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            setupEventHandlers();
            initializeLiff();
        });
    </script>
</body>
</html>
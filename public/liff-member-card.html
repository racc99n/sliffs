<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima789 Member Card</title>
    <script src="https://static.line-scdn.net/liff/2.22.3/liff.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        #loader { display: block; }
        #member-card-content, #linking-prompt { display: none; }
        .card { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card h2 { color: #007bff; }
        .card p { font-size: 1.2em; }
        button { padding: 10px 20px; font-size: 1em; cursor: pointer; }
    </style>
</head>
<body>
    <div id="loader">
      <h1>กำลังตรวจสอบสถานะ...</h1>
      <p>กรุณารอสักครู่</p>
    </div>

    <div id="member-card-content">
      <div class="card">
        <h2>บัตรสมาชิก Prima789</h2>
        <p>ชื่อผู้ใช้: <span id="username"></span></p>
        <p>ยอดเงินคงเหลือ: <span id="balance"></span> THB</p>
      </div>
    </div>

    <div id="linking-prompt">
      <h1>ยังไม่มีการเชื่อมโยงบัญชี</h1>
      <p>กรุณาเชื่อมโยงบัญชีเพื่อเข้าถึงข้อมูลสมาชิก</p>
      <button onclick="linkAccount()">เชื่อมโยงบัญชี</button>
    </div>

    <script>
        // LIFF ID สำหรับ Member Card
        const LIFF_ID_MEMBER_CARD = "2008090006-ZV6r9v5J";
        // LIFF ID สำหรับ Account Linking
        const LIFF_ID_ACCOUNT_LINKING = "2008090006-ZMGmoOla";
      
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID_MEMBER_CARD });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    checkLinkingStatus();
                }
            } catch (err) {
                console.error('LIFF initialization failed', err);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('linking-prompt').style.display = 'block';
            }
        }

        async function checkLinkingStatus() {
            const profile = await liff.getProfile();
            const lineUserId = profile.userId;

            try {
                // เรียก Netlify Function ที่ตรวจสอบสถานะการเชื่อมโยง
                const response = await fetch(`/.netlify/functions/check-account-linking?lineUserId=${lineUserId}`);
                const data = await response.json();

                if (data.isLinked) {
                    displayMemberCard(data.linkData);
                } else {
                    document.getElementById('linking-prompt').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to check linking status:', error);
                document.getElementById('linking-prompt').style.display = 'block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function displayMemberCard(userData) {
            document.getElementById('username').textContent = userData.username;
            document.getElementById('balance').textContent = parseFloat(userData.balance).toFixed(2);
            document.getElementById('member-card-content').style.display = 'block';
        }

        function linkAccount() {
            liff.openWindow({ url: '/liff-account-linking.html', external: false });
        }

        initializeLiff();
    </script>
</body>
</html>